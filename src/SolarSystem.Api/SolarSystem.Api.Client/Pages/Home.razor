@page "/"
@using System.Net.Http.Json
@using Microsoft.AspNetCore.SignalR.Client
@using SolarSystem.Shared.DTOs
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@implements IAsyncDisposable

<PageTitle>Solar System Explorer</PageTitle>

<div class="solar-system-container">
    @if (isLoading)
    {
        <div class="loading-screen">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading Solar System...</div>
        </div>
    }

    <!-- Header -->
    <header class="app-header">
        <h1>🌌 <span>Solar System</span> Explorer</h1>
        <div class="header-actions">
            <span class="sim-status @(isPaused ? "paused" : "running")">
                @(isPaused ? "⏸ Paused" : "▶ Running")
            </span>
        </div>
    </header>

    <!-- 3D Canvas Container -->
    <div id="solar-system-canvas"></div>

    @if (!isLoading)
    {
        <!-- Planet Quick Select -->
        <div class="planet-selector">
            @foreach (var planet in planets.Where(p => p.BodyType == "Star" || p.IsPlanet))
            {
                <button class="planet-btn @(selectedPlanetId == planet.Id ? "selected" : "")"
                        @onclick="() => FocusPlanet(planet.EnglishName)"
                        title="@planet.EnglishName">
                    @GetPlanetEmoji(planet.EnglishName)
                </button>
            }
        </div>

        <!-- Time Display -->
        <div class="time-display">
            <label>Simulation Date</label>
            <div class="date">@simulationTime.ToString("MMM dd, yyyy")</div>
            <div class="time">@simulationTime.ToString("HH:mm:ss")</div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <button class="control-btn @(!isPaused ? "active" : "")" @onclick="TogglePlay">
                @(isPaused ? "▶ Play" : "⏸ Pause")
            </button>
            
            <div class="speed-control">
                <span>Speed: @timeMultiplier.ToString("0.#")x</span>
                <input type="range" class="speed-slider" 
                       min="0.1" max="100" step="0.1" 
                       value="@timeMultiplier" 
                       @onchange="OnSpeedChange" />
            </div>
            
            <button class="control-btn" @onclick="ResetView">
                🔄 Reset View
            </button>
        </div>

        <!-- Planet Info Panel -->
        <div class="planet-info-panel @(selectedPlanet != null ? "visible" : "")">
            @if (selectedPlanet != null)
            {
                <button class="close-btn" @onclick="ClosePlanetPanel">×</button>
                
                <h2>@GetPlanetEmoji(selectedPlanet.EnglishName) @selectedPlanet.EnglishName</h2>
                <p class="body-type">@selectedPlanet.BodyType</p>
                
                @if (!string.IsNullOrEmpty(selectedPlanet.Description))
                {
                    <p class="description">@selectedPlanet.Description</p>
                }

                <div class="info-section">
                    <h3>Physical Properties</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Radius</label>
                            <span class="value">@FormatNumber(selectedPlanet.MeanRadius) km</span>
                        </div>
                        <div class="info-item">
                            <label>Mass</label>
                            <span class="value">@selectedPlanet.Mass × 10^@selectedPlanet.MassExponent kg</span>
                        </div>
                        <div class="info-item">
                            <label>Gravity</label>
                            <span class="value">@selectedPlanet.Gravity.ToString("F2") m/s²</span>
                        </div>
                        <div class="info-item">
                            <label>Temperature</label>
                            <span class="value">@selectedPlanet.MeanTemperature K</span>
                        </div>
                    </div>
                </div>

                @if (selectedPlanet.Orbit != null)
                {
                    <div class="info-section">
                        <h3>Orbital Data</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Orbital Period</label>
                                <span class="value">@selectedPlanet.Orbit.OrbitalPeriod.ToString("F1") days</span>
                            </div>
                            <div class="info-item">
                                <label>Distance from Sun</label>
                                <span class="value">@FormatNumber(selectedPlanet.Orbit.SemimajorAxis) km</span>
                            </div>
                        </div>
                    </div>
                }

                @if (selectedPlanet.Layers?.Any() == true)
                {
                    <div class="info-section">
                        <h3>Internal Structure</h3>
                        <ul class="layer-list">
                            @foreach (var layer in selectedPlanet.Layers.OrderBy(l => l.LayerOrder))
                            {
                                <li class="layer-item">
                                    <span class="layer-color" style="background-color: @(layer.Color ?? "#666")"></span>
                                    <span class="layer-name">@layer.LayerName</span>
                                    <span class="layer-temp">@layer.Temperature K</span>
                                </li>
                            }
                        </ul>
                    </div>
                }

                @if (selectedPlanet.Moons?.Any() == true)
                {
                    <div class="info-section">
                        <h3>Moons (@selectedPlanet.Moons.Count)</h3>
                        <div class="moon-list">
                            @foreach (var moon in selectedPlanet.Moons)
                            {
                                <span class="moon-tag">🌑 @moon.Name</span>
                            }
                        </div>
                    </div>
                }
            }
        </div>
    }
</div>

@code {
    private List<CelestialBodyDto> planets = new();
    private CelestialBodyDetailDto? selectedPlanet;
    private int? selectedPlanetId;
    private bool isLoading = true;
    private bool isPaused = false; // Start running
    private double timeMultiplier = 100.0; // Start faster
    private DateTime simulationTime = DateTime.UtcNow;
    private HubConnection? hubConnection;
    private DotNetObjectReference<Home>? dotNetRef;
    private System.Threading.Timer? timer;
    private bool isInitialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isInitialized)
        {
            isInitialized = true;
            await InitializeAsync();
        }
    }

    private async Task InitializeAsync()
    {
        try
        {
            // Load planets from API
            planets = await Http.GetFromJsonAsync<List<CelestialBodyDto>>("/api/celestialbodies/planets") ?? new();
            
            isLoading = false;
            StateHasChanged();

            // Wait for DOM update
            await Task.Delay(100);

            // Initialize Three.js scene
            dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("initSolarSystem", "solar-system-canvas", dotNetRef);
            await JS.InvokeVoidAsync("loadPlanets", planets);

            // Setup SignalR
            try
            {
                hubConnection = new HubConnectionBuilder()
                    .WithUrl(NavigationManager.ToAbsoluteUri("/hubs/simulation"))
                    .WithAutomaticReconnect()
                    .Build();

                hubConnection.On<double>("TimeMultiplierChanged", (multiplier) =>
                {
                    timeMultiplier = multiplier;
                    InvokeAsync(StateHasChanged);
                });

                hubConnection.On<bool>("PauseStateChanged", (paused) =>
                {
                    isPaused = paused;
                    InvokeAsync(StateHasChanged);
                });

                await hubConnection.StartAsync();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"SignalR error: {ex.Message}");
            }

            // Start simulation time update
            timer = new System.Threading.Timer(async _ => 
            {
                if (!isPaused)
                {
                    simulationTime = simulationTime.AddSeconds(timeMultiplier * 0.1);
                    await InvokeAsync(StateHasChanged);
                }
            }, null, 0, 100);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing: {ex.Message}");
            isLoading = false;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public async Task OnPlanetSelected(int id, string name)
    {
        selectedPlanetId = id;
        
        try
        {
            selectedPlanet = await Http.GetFromJsonAsync<CelestialBodyDetailDto>($"/api/celestialbodies/{id}");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading planet details: {ex.Message}");
        }
    }

    private async Task FocusPlanet(string planetName)
    {
        await JS.InvokeVoidAsync("focusPlanet", planetName);
    }

    private async Task TogglePlay()
    {
        isPaused = !isPaused;
        await JS.InvokeVoidAsync("togglePause", isPaused);
        
        if (hubConnection?.State == HubConnectionState.Connected)
        {
            await hubConnection.InvokeAsync("TogglePause", isPaused);
        }
    }

    private async Task OnSpeedChange(ChangeEventArgs e)
    {
        if (double.TryParse(e.Value?.ToString(), out var speed))
        {
            timeMultiplier = speed;
            await JS.InvokeVoidAsync("setTimeMultiplier", timeMultiplier);
            
            if (hubConnection?.State == HubConnectionState.Connected)
            {
                await hubConnection.InvokeAsync("UpdateTimeMultiplier", timeMultiplier);
            }
        }
    }

    private async Task ResetView()
    {
        await JS.InvokeVoidAsync("resetView");
        selectedPlanet = null;
        selectedPlanetId = null;
    }

    private void ClosePlanetPanel()
    {
        selectedPlanet = null;
        selectedPlanetId = null;
    }

    private string GetPlanetEmoji(string name) => name switch
    {
        "Sun" => "☀️",
        "Mercury" => "☿️",
        "Venus" => "♀️",
        "Earth" => "🌍",
        "Mars" => "♂️",
        "Jupiter" => "♃",
        "Saturn" => "🪐",
        "Uranus" => "⛢",
        "Neptune" => "♆",
        _ => "🌑"
    };

    private string FormatNumber(double num)
    {
        if (num >= 1_000_000) return $"{num / 1_000_000:F1}M";
        if (num >= 1_000) return $"{num / 1_000:F1}K";
        return num.ToString("F1");
    }

    public async ValueTask DisposeAsync()
    {
        timer?.Dispose();
        dotNetRef?.Dispose();
        
        if (hubConnection != null)
        {
            await hubConnection.DisposeAsync();
        }
        
        try
        {
            await JS.InvokeVoidAsync("disposeScene");
        }
        catch { }
    }
}
